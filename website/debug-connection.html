<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Shared Elements Connection</title>
    <style>
        body { font-family: monospace; padding: 2rem; background: #f0f0f0; }
        .log { background: #000; color: #0f0; padding: 1rem; margin: 1rem 0; border-radius: 4px; height: 300px; overflow-y: scroll; }
        .section { background: white; padding: 1rem; margin: 1rem 0; border-radius: 4px; }
        .status { padding: 0.5rem; margin: 0.5rem 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007acc; color: white; border: none; padding: 0.5rem 1rem; margin: 0.25rem; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîß Shared Elements Connection Debug</h1>
    
    <div class="section">
        <h2>Current Page Info</h2>
        <p><strong>URL:</strong> <span id="current-url"></span></p>
        <p><strong>Host:</strong> <span id="current-host"></span></p>
        <p><strong>Path:</strong> <span id="current-path"></span></p>
    </div>

    <div class="section">
        <h2>Elements on Page</h2>
        <div id="elements-info"></div>
    </div>

    <div class="section">
        <h2>Discovery Test</h2>
        <button onclick="testDiscovery()">Run Discovery Test</button>
        <div id="discovery-results"></div>
    </div>

    <div class="section">
        <h2>PlayHTML Connection Test</h2>
        <button onclick="testPlayHTML()">Test PlayHTML Init</button>
        <div id="playhtml-status"></div>
    </div>

    <div class="section">
        <h2>Test Elements</h2>
        <!-- Shared element for testing -->
        <div id="debug-shared" shared>Debug Shared Element</div>
        <!-- Reference element for testing -->
        <div id="debug-ref" data-source="localhost:5173/debug-connection#debug-shared">Debug Reference</div>
    </div>

    <div class="section">
        <h2>Console Logs</h2>
        <div id="console-log" class="log"></div>
    </div>

    <script type="module">
        let logContainer = document.getElementById('console-log');
        let originalConsoleLog = console.log;
        let originalConsoleError = console.error;
        
        function addToLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#ff0000' : '#00ff00';
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };

        // Initialize page info
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('current-host').textContent = window.location.host;
        document.getElementById('current-path').textContent = window.location.pathname;

        // Show elements
        function updateElementsInfo() {
            const sharedElements = document.querySelectorAll('[shared], [shared-domain], [shared-global]');
            const refElements = document.querySelectorAll('[data-source]');
            
            document.getElementById('elements-info').innerHTML = `
                <p>üìã Shared elements found: ${sharedElements.length}</p>
                <p>üîó Reference elements found: ${refElements.length}</p>
                <ul>
                    ${Array.from(sharedElements).map(el => `<li>Shared: #${el.id} [${Array.from(el.attributes).map(a => a.name).join(', ')}]</li>`).join('')}
                    ${Array.from(refElements).map(el => `<li>Reference: #${el.id} ‚Üí ${el.getAttribute('data-source')}</li>`).join('')}
                </ul>
            `;
        }
        
        updateElementsInfo();

        window.testDiscovery = function() {
            console.log('üîç Running discovery test...');
            
            const sharedElements = [];
            document.querySelectorAll('[shared], [shared-domain], [shared-global]').forEach((el) => {
                if (!el.id) return;
                
                let scope = 'global';
                let permissions = 'read-write';
                
                if (el.hasAttribute('shared-domain')) {
                    scope = 'domain';
                    const attrValue = el.getAttribute('shared-domain');
                    if (attrValue && attrValue !== '') {
                        permissions = attrValue.includes('read-only') ? 'read-only' : 'read-write';
                    }
                } else if (el.hasAttribute('shared-global')) {
                    scope = 'global';
                    const attrValue = el.getAttribute('shared-global');
                    if (attrValue && attrValue !== '') {
                        permissions = attrValue.includes('read-only') ? 'read-only' : 'read-write';
                    }
                } else if (el.hasAttribute('shared')) {
                    scope = 'global';
                    const attrValue = el.getAttribute('shared');
                    if (attrValue && attrValue !== '') {
                        permissions = attrValue.includes('read-only') ? 'read-only' : 'read-write';
                    }
                }
                
                sharedElements.push({
                    elementId: el.id,
                    permissions,
                    scope,
                    path: window.location.pathname,
                });
            });
            
            const sharedReferences = [];
            document.querySelectorAll('[data-source]').forEach((el) => {
                const dataSource = el.getAttribute('data-source');
                if (!dataSource) return;
                
                const [domainAndPath, elementId] = dataSource.split('#');
                if (!domainAndPath || !elementId) return;
                
                const pathIndex = domainAndPath.indexOf('/');
                const domain = pathIndex === -1 ? domainAndPath : domainAndPath.substring(0, pathIndex);
                const path = pathIndex === -1 ? '/' : domainAndPath.substring(pathIndex);
                
                sharedReferences.push({ domain, path, elementId });
            });
            
            console.log('‚úÖ Discovered shared elements:', sharedElements);
            console.log('‚úÖ Discovered shared references:', sharedReferences);
            
            document.getElementById('discovery-results').innerHTML = `
                <div class="status success">
                    <strong>Discovery Results:</strong><br>
                    Shared Elements: ${sharedElements.length}<br>
                    Shared References: ${sharedReferences.length}
                </div>
                <pre>${JSON.stringify({ sharedElements, sharedReferences }, null, 2)}</pre>
            `;
        };

        window.testPlayHTML = async function() {
            const statusDiv = document.getElementById('playhtml-status');
            statusDiv.innerHTML = '<div class="status warning">Testing PlayHTML initialization...</div>';
            
            try {
                console.log('üì¶ Importing PlayHTML...');
                const { playhtml } = await import('/packages/playhtml/dist/playhtml.es.js');
                console.log('‚úÖ PlayHTML imported successfully');
                
                console.log('üöÄ Initializing PlayHTML...');
                await playhtml.init({
                    developmentMode: true,
                    host: 'localhost:1999'
                });
                console.log('‚úÖ PlayHTML initialized successfully');
                
                statusDiv.innerHTML = '<div class="status success">‚úÖ PlayHTML initialization successful!</div>';
                
            } catch (error) {
                console.error('‚ùå PlayHTML test failed:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå PlayHTML failed: ${error.message}</div>`;
            }
        };

        // Auto-run discovery test
        setTimeout(testDiscovery, 1000);
    </script>
</body>
</html>