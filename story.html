<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="one word story powered by playhtml" />
    <meta name="og:image" content="https://playhtml.fun/playhtml-story.png" />

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Carter+One&family=Play:wght@400;700&family=Rubik+Pixels&family=Yellowtail&display=swap"
      rel="stylesheet"
    />

    <title>playhtml</title>
    <script
      defer
      data-domain="playhtml.fun"
      data-api="https://sharingan.spencerc99.workers.dev/genjutsu/event"
      src="https://sharingan.spencerc99.workers.dev/genjutsu/script.js"
    ></script>
  </head>
  <body>
    <div id="app">
      <div class="content">
        <h1>one word story</h1>
        <i>a game powered by <a href="/">playhtml</a></i>
        <p>let's play a game and make a story together!</p>
        <ol>
          <li>
            <p>
              Try to only add a few words every 24 hours to make space for
              others to "yes and" you.
            </p>
          </li>
          <li>
            <p>
              Before you start, choose a color so you can be associated with it
              :)
              <input
                id="colorPicker"
                type="color"
                onChange="updateUserColor(this.value)"
              />
            </p>
          </li>
          <li>
            <p>
              Contribute by clicking the mail button or hitting
              <kbd>Enter</kbd> while editing the input.
            </p>
          </li>
          <li>
            <p>Come back to see how it evolves.</p>
          </li>
        </ol>
        <br />
        <h3>
          our story<br />
          <i>last updated <span id="lastUpdatedTime"></span></i>
          <span style="float: right"
            ><span id="activeOrb"></span>
            <span id="activeUsersCount">1</span> active users</span
          >
        </h3>
        <p id="story">
          Once upon a time,
          <span id="storyContent"></span>
          <input
            id="wordInput"
            type="text"
            placeholder="your story word..."
            can-play
          />
          <button class="wordSubmit">ðŸ“¤</button>
          <br />
          <span id="typingIndicators"></span>
          <script>
            const input = document.getElementById("wordInput");
            const submitBtn = document.querySelector(".wordSubmit");
            const storyContent = document.getElementById("storyContent");
            const typingIndicators =
              document.getElementById("typingIndicators");
            function updateUserColor(color) {
              localStorage.setItem("color", JSON.stringify(color));
            }
            function getUserColor() {
              return localStorage.getItem("color")
                ? JSON.parse(localStorage.getItem("color"))
                : undefined;
            }
            function randomColor() {
              const hex = Math.floor(Math.random() * 16777215).toString(16);
              return "#" + hex;
            }
            function convertHexToRGB(hex) {
              const r = parseInt(hex.slice(1, 3), 16);
              const g = parseInt(hex.slice(3, 5), 16);
              const b = parseInt(hex.slice(5, 7), 16);
              return { r, g, b };
            }
            function getColorVar(color) {
              if (!color) {
                return "transparent";
              }

              const { r, g, b } = convertHexToRGB(color);
              return `${r}, ${g}, ${b}`;
            }

            if (getUserColor() === undefined) {
              updateUserColor(randomColor());
            }
            colorPicker.value = getUserColor();
            function isValidWord(word) {
              return word.split(/\s+/).length === 1;
            }

            input.defaultData = [];
            input.myDefaultAwareness = null;
            input.additionalSetup = ({
              setData,
              getData,
              setLocalAwareness,
            }) => {
              const onSubmit = () => {
                submitBtn.disabled = true;
                if (!isValidWord(input.value)) {
                  alert("please enter a single word!");
                  submitBtn.disabled = false;
                  return;
                }
                const existingStory = getData();
                const newEntry = {
                  word: input.value,
                  color: getUserColor(),
                  ts: Date.now(),
                };
                setData([...existingStory, newEntry]);
                input.value = "";
                setLocalAwareness(null);
                submitBtn.disabled = false;
              };

              submitBtn.addEventListener("click", onSubmit);
              input.addEventListener("keydown", (event) => {
                if (event.key === "Enter") {
                  onSubmit();
                }
              });
              input.addEventListener("input", (event) => {
                if (event.target.value === "") {
                  setLocalAwareness(null);
                } else {
                  setLocalAwareness(getUserColor());
                }
              });
            };
            input.updateElementAwareness = ({ awareness, myAwareness }) => {
              // people active on the site but not typing will be set to null
              const activeUsers = awareness.filter((c) => Boolean(c));
              const otherActiveUsers = [...activeUsers];
              const myIndex = otherActiveUsers.findIndex(
                (c) => c === myAwareness
              );

              // remove first instance of myAwareness to get everyone else and handle duplicates
              if (myIndex !== -1) {
                otherActiveUsers.splice(myIndex, 1);
              }
              const typingUsers = [];
              for (const color of otherActiveUsers) {
                typingUsers.push(`<div  class="typingIndicator" style="--word-color:${getColorVar(
                  color
                )}">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>`);
              }
              typingIndicators.innerHTML = typingUsers.join("\n");

              activeUsersCount.innerText = awareness.length;
            };
            input.updateElement = ({ data }) => {
              if (data.length > 0) {
                const lastDate = new Date(data[data.length - 1].ts);
                lastUpdatedTime.innerText =
                  lastDate.toLocaleTimeString() +
                  " on " +
                  lastDate.toLocaleDateString();
              }

              storyContent.innerHTML = data
                .map(
                  ({ word, color }) =>
                    `<span class="word" style="--word-color:${getColorVar(
                      color
                    )}">${word}</span>`
                )
                .join("\n");
            };
          </script>
        </p>
      </div>
    </div>
    <footer>
      <div>
        an open-source library created and maintained by
        <a href="https://www.spencerchang.me/">spencer</a>, powered by
        <a href="https://partykit.io">partykit</a>
      </div>
    </footer>

    <script type="module" src="./website/story.ts"></script>
    <script type="module">
      import "./src/main.ts";
      playhtml.init();
    </script>
    <link rel="stylesheet" href="https://unpkg.com/playhtml/dist/style.css" />
    <!-- import cursor chat -->
    <!-- TODO: implement custom cursor chat with color select, other settings -->
    <div id="cursor-chat-layer">
      <input type="text" id="cursor-chat-box" />
    </div>
    <script type="module">
      import { initCursorChat } from "https://esm.sh/cursor-chat";
      initCursorChat(window.location.href, {
        color: getUserColor(),
      });
    </script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://unpkg.com/cursor-chat/dist/style.css"
    />
  </body>
</html>
